# ==============================================
# NGINX Configuration for app-exp.dev.lan
# Collabora CODE + Frontend + Backend Integration
# ==============================================

# ==============================================
# HTTPS Server for app-exp.dev.lan
# ==============================================
server {
    listen 443 ssl http2;
    server_name app-exp.dev.lan;

    # SSL Configuration
    ssl_certificate /etc/ssl/certs/app-exp-dev/cert.pem;
    ssl_certificate_key /etc/ssl/private/app-exp-dev/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Timeout and Size Settings
    client_max_body_size 25M;
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    send_timeout 300s;

    # Logging
    access_log /var/log/nginx/app-exp-access.log;
    error_log /var/log/nginx/app-exp-error.log;

    # ----------------------
    # Frontend Application
    # ----------------------
    location / {
        root /var/www/app-exp-frontend;
        try_files $uri $uri/ /index.html;
        index index.html;

        # Security headers
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        # Note: X-Frame-Options removed to allow Collabora iframe
    }

    # Static assets with caching
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
        root /var/www/app-exp-frontend;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ----------------------
    # Backend API (if you have one)
    # ----------------------
    location /gxpmax/back {
        proxy_pass http://localhost:5000/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        proxy_request_buffering off;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ----------------------
    # Document Management API
    # ----------------------
    location /api/ {
        proxy_pass http://localhost:5001/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Disable buffering for uploads
        proxy_request_buffering off;
        proxy_buffering off;

        # CORS headers
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "*" always;

        # Handle OPTIONS requests
        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    # ----------------------
    # WOPI Server (Document Backend)
    # ----------------------
    location /wopi/ {
        proxy_pass http://localhost:5001/wopi/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WOPI-specific headers
        proxy_set_header X-WOPI-Override $http_x_wopi_override;

        # Disable buffering for WOPI
        proxy_request_buffering off;
        proxy_buffering off;

        # CORS headers for WOPI (if needed)
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, OPTIONS" always;
        add_header Access-Control-Allow-Headers "*" always;

        # Handle OPTIONS requests
        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    # ----------------------
    # Collabora CODE Endpoints
    # ----------------------

    # Static files for Collabora (CSS, JS, images)
    location ^~ /browser {
        proxy_pass http://127.0.0.1:9980;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WOPI discovery endpoint (required for Collabora)
    location ^~ /hosting/discovery {
        proxy_pass http://127.0.0.1:9980;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # Capabilities endpoint
    location ^~ /hosting/capabilities {
        proxy_pass http://127.0.0.1:9980;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # Main WebSocket for document editing
    # CRITICAL: This MUST come BEFORE the general /cool location
    location ~ ^/cool/(.*)/ws$ {
        proxy_pass http://127.0.0.1:9980;
        proxy_http_version 1.1;

        # WebSocket headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Long timeout for WebSocket
        proxy_read_timeout 36000s;
        proxy_send_timeout 36000s;
    }

    # Admin Console WebSocket
    location ^~ /cool/adminws {
        proxy_pass http://127.0.0.1:9980;
        proxy_http_version 1.1;

        # WebSocket headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_read_timeout 36000s;
    }

    # Download, presentation, and image upload
    # IMPORTANT: Must come AFTER WebSocket locations
    location ~ ^/(c|l)ool {
        proxy_pass http://127.0.0.1:9980;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Disable buffering for better performance
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # Legacy loleaflet endpoint (for older Collabora versions)
    location ^~ /loleaflet {
        proxy_pass http://127.0.0.1:9980;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # Legacy lool endpoint
    location ^~ /lool {
        proxy_pass http://127.0.0.1:9980;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # ----------------------
    # Health Check Endpoints
    # ----------------------

    # Application health check
    location /health {
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # WOPI server health check
    location /wopi/health {
        proxy_pass http://localhost:5001/health;
        proxy_http_version 1.1;
    }
}

# ==============================================
# HTTP â†’ HTTPS Redirect
# ==============================================
server {
    listen 80;
    server_name app-exp.dev.lan;

    # Redirect all HTTP traffic to HTTPS
    return 301 https://$host$request_uri;
}

# ==============================================
# Notes and Troubleshooting
# ==============================================
#
# 1. WebSocket Location Order is CRITICAL:
#    - WebSocket locations (~ ^/cool/(.*)/ws$) MUST come before
#    - General locations (~ ^/(c|l)ool)
#    - Otherwise, WebSocket connections will fail
#
# 2. SSL Certificates:
#    - Ensure cert.pem and key.pem exist at specified paths
#    - Self-signed certs work for testing but will show browser warnings
#
# 3. Collabora Docker Container:
#    - Must be running on port 9980
#    - Must have domain configured: domain=app-exp\\.dev\\.lan
#    - Must allow frame ancestors: --o:net.frame_ancestors=*
#
# 4. WOPI Server:
#    - Must be running on port 5001
#    - Must be accessible at http://localhost:5001
#
# 5. File Paths:
#    - Frontend: /var/www/app-exp-frontend
#    - Ensure proper permissions: sudo chown -R www-data:www-data
#
# 6. Testing:
#    - Test config: sudo nginx -t
#    - Reload: sudo systemctl reload nginx
#    - Check logs: sudo tail -f /var/log/nginx/app-exp-error.log
#
